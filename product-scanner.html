<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>EcoReveal - Product Scanner</title>
    <link rel="stylesheet" href="styles/main.css" />
  </head>
  <body>
    <h1>EcoReveal Product Scanner</h1>

    <div class="scanner-container">
      <input type="file" id="uploadInput" accept="image/*" style="display: none" />
      <button id="uploadBtn" class="btn">Upload Image</button>
      <button id="cameraBtn" class="btn">Use Camera</button>
      <video id="cameraStream" autoplay playsinline style="display: none"></video>
      <canvas id="cameraCanvas" style="display: none"></canvas>
    </div>

    <button id="analyzeImageBtn" class="btn">Analyze</button>
    <p id="scanResult">No image uploaded yet.</p>

    <script src="scripts/ai.js"></script>
    <script>
      const uploadBtn = document.getElementById("uploadBtn");
      const cameraBtn = document.getElementById("cameraBtn");
      const uploadInput = document.getElementById("uploadInput");
      const cameraStream = document.getElementById("cameraStream");
      const cameraCanvas = document.getElementById("cameraCanvas");
      const analyzeImageBtn = document.getElementById("analyzeImageBtn");
      const scanResult = document.getElementById("scanResult");

      let currentImage = null;

      // Upload flow
      uploadBtn.addEventListener("click", () => uploadInput.click());
      uploadInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => {
            currentImage = reader.result;
            scanResult.textContent = "Image uploaded. Ready to analyze.";
          };
          reader.readAsDataURL(file);
        }
      });

      // Camera flow
      cameraBtn.addEventListener("click", async () => {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          cameraStream.srcObject = stream;
          cameraStream.style.display = "block";
        } else {
          alert("Camera not supported on this device.");
        }
      });

      analyzeImageBtn.addEventListener("click", async () => {
        if (cameraStream.style.display === "block") {
          // Capture from camera
          const ctx = cameraCanvas.getContext("2d");
          cameraCanvas.width = cameraStream.videoWidth;
          cameraCanvas.height = cameraStream.videoHeight;
          ctx.drawImage(cameraStream, 0, 0);
          currentImage = cameraCanvas.toDataURL("image/jpeg");
        }

        if (!currentImage) {
          scanResult.textContent = "Please upload or capture an image first.";
          return;
        }

        scanResult.textContent = "Analyzing...";
        const explanation = await EcoAI.explain(currentImage, "image");
        scanResult.textContent = explanation;
      });
    </script>
  </body>
</html>
